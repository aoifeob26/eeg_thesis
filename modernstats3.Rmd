---
title: "Language Proficiency Classification using EEG FPCA"
author: "Aoife [Your Student Number]"
date: "2025-04-01"
output: html_document
---

```{r packages, echo=FALSE, message=FALSE, warning=FALSE}
library(fda)
library(dplyr)
library(ggplot2)
library(randomForest)
library(caret)
library(skimr)
library(table1)
```

## Introduction

This report investigates the classification of EEG responses to stimuli using functional principal component analysis (FPCA) on data from two frontal electrodes (FP1 and FP2). The smoothed data is derived using a fourier basis. A random forest model is applied to predict the matching condition of the stimulus.

## Load and Prepare Data

```{r}
firsttrial <- readRDS("firsttrial_data.rds")
time <- seq(0, 1, length.out = 256)

```

```{r}
library(fda)
library(dplyr)
library(caret)
library(randomForest)

# Load and prep data
firsttrial <- readRDS("firsttrial_data.rds")
time <- seq(0, 1, length.out = 256)

# Create fourier basis
basis <- create.fourier.basis(rangeval = range(time), nbasis = length(time)/2)
fdParObj <- fdPar(basis, Lfdobj = 2, lambda = 1e-2)

# FP1
fp1_data <- firsttrial %>% filter(sensor.position == "FP1") %>%
  arrange(matching.condition, subject.identifier, name, time)
mat_fp1 <- matrix(as.numeric(fp1_data$sensor.value), nrow = 256)
fd_fp1 <- smooth.basis(time, mat_fp1, fdParObj)$fd
res_fp1 <- pca.fd(fd_fp1, nharm = 20)
scores_fp1 <- as.data.frame(res_fp1$scores)
colnames(scores_fp1) <- paste0("FP1_", 1:20)

# FP2
fp2_data <- firsttrial %>% filter(sensor.position == "FP2") %>%
  arrange(matching.condition, subject.identifier, name, time)
mat_fp2 <- matrix(as.numeric(fp2_data$sensor.value), nrow = 256)
fd_fp2 <- smooth.basis(time, mat_fp2, fdParObj)$fd
res_fp2 <- pca.fd(fd_fp2, nharm = 20)
scores_fp2 <- as.data.frame(res_fp2$scores)
colnames(scores_fp2) <- paste0("FP2_", 1:20)

# Metadata
meta <- fp1_data %>% filter(time == 0) %>%
  select(matching.condition, subject.identifier)

# Combine
fpca_data <- cbind(meta, scores_fp1, scores_fp2)
fpca_data$subject.identifier <- as.factor(fpca_data$subject.identifier)

set.seed(123)
train_idx <- createDataPartition(fpca_data$matching.condition, p = 0.7, list = FALSE)
train_data <- fpca_data[train_idx, ]
test_data <- fpca_data[-train_idx, ]

# Check class balance
table(train_data$matching.condition)
table(test_data$matching.condition)

# Train model
rf_model <- randomForest(subject.identifier ~ ., data = train_data, importance = TRUE)
pred <- predict(rf_model, newdata = test_data)

# Accuracy
acc <- mean(pred == test_data$subject.identifier)
cat("Random Forest Accuracy (fourier, 15 harmonics):", round(acc * 100, 2), "%\n")

```

```{r}
library(rpart)
library(rpart.plot)

tree_model <- rpart(subject.identifier ~ ., data = train_data, method = "class", cp = 0.001)
rpart.plot(tree_model, type = 2, extra = 101, box.palette = "Blues", main = "Classification Tree")
```



```{r}
tree_pred <- predict(tree_model, newdata = test_data, type = "class")
confusionMatrix(tree_pred, test_data$subject.identifier)
```







## Evaluation

The random forest classifier achieved an accuracy of approximately `r round(accuracy * 100, 2)`%. Key components driving the classification were among the early FP1 and FP2 harmonics.

## Concerns

- The outcome variable is not necessarily balanced.
- Interpretation of components is limited to abstract signal variance, not physical brain activity.
- The relatively small sample size could cause overfitting.

## Conclusion

Using FPCA with a fourier basis and a random forest model, we demonstrated the potential to predict stimulus matching condition from EEG data. This workflow can be adapted to explore other channels or to compare basis functions.



