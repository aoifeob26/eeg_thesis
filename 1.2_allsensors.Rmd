---
title: "datacleaning2"
output: html_document
date: "2025-03-25"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

# Get the names of all the files in the data folder underneath the folder this Rmd file is saved in
filenames <- list.files("/Users/aoife/OneDrive - National University of Ireland, Galway/HDS Project/data/SMNI_CMI_TEST/Test")

# Set up a blank list to hold the data
files <- list()

# Loop over all the files in the folder
for(i in 1:length(filenames)){
  # For each filename, read it in
  cleaned_data <- read.csv(paste0("/Users/aoife/OneDrive - National University of Ireland, Galway/HDS Project/data/SMNI_CMI_TEST/Test/", filenames[i]))
  
  # Perform general cleaning without filtering specific sensors
  cleaned_data <- cleaned_data %>%
    mutate(
      sensor.position = as.factor(sensor.position),
      subject.identifier = as.factor(subject.identifier),
      trial.number = as.factor(trial.number)
    ) %>%
    arrange(trial.number, time)
  
  # Save cleaned data into the list
  files[[i]] <- cleaned_data
}

# Combine the list into a single data frame
dat <- do.call(rbind, files)

# View cleaned data
head(dat)
summary(dat)

```


```{r}
# Convert trial.number to numeric
dat$trial.number <- as.numeric(as.character(dat$trial.number))

# Select observations at time 0 only (baseline measurement)
datsmall <- dat %>% filter(time == 0)

# Keep only first trials per subject and condition (across all sensors consistently)
first_trials_info <- dat %>%
  group_by(name, matching.condition) %>%
  summarise(min_trial = min(trial.number), .groups = "drop")

firsttrial <- dat %>%
  inner_join(first_trials_info, by = c("name", "matching.condition")) %>%
  filter(trial.number == min_trial)


# Verify data structure after filtering
head(firsttrial)
summary(firsttrial)

firsttrial %>%
  filter(name != "co2a0000371") %>%
  ggplot(aes(x = time, y = sensor.value, color = matching.condition)) +
  geom_line(alpha = 0.5) +
  facet_wrap(~ sensor.position, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(title = "Sensor Values Across All Sensors by Condition (excluding co2a0000371)")

# Visualise example subject across all sensors
firsttrial %>%
  filter(name == "co2a0000364") %>%
  ggplot(aes(x = time, y = sensor.value, color = subject.identifier)) +
  geom_line(alpha = 0.5) +
  facet_wrap(~ sensor.position, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(title = "Sensor Values for Subject co2a0000364 Across All Sensors")

# Smoothed trends across sensors by matching condition
firsttrial %>%
  filter(name != "co2a0000371") %>%
  ggplot(aes(x = time, y = sensor.value, color = matching.condition)) +
  geom_smooth(se = FALSE) +
  facet_wrap(~ sensor.position, scales = "free_y") +
  theme_bw() +
  labs(title = "Smoothed Sensor Trends by Condition (excluding co2a0000371)")

# Smoothed trends across sensors by subject identifier
firsttrial %>%
  filter(name != "co2a0000371") %>%
  ggplot(aes(x = time, y = sensor.value, color = subject.identifier)) +
  geom_smooth(se = FALSE) +
  facet_wrap(~ sensor.position + matching.condition, scales = "free_y") +
  theme_bw() +
  labs(title = "Smoothed Sensor Trends by Subject and Condition (excluding co2a0000371)")

```

```{r}
 
saveRDS(firsttrial, file = "firsttrial_allsensors_data.rds")

```
 

