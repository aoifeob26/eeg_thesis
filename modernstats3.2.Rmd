---
title: "Language Proficiency Classification using EEG FPCA"
author: "Aoife [Your Student Number]"
date: "2025-04-01"
output: html_document
---

```{r packages, echo=FALSE, message=FALSE, warning=FALSE}
library(fda)
library(dplyr)
library(ggplot2)
library(randomForest)
library(caret)
library(skimr)
library(table1)
```

## Introduction

This report investigates the classification of EEG responses to stimuli using functional principal component analysis (FPCA) on data from two frontal electrodes (FP1 and FP2). The smoothed data is derived using a bspline basis. A random forest model is applied to predict the matching condition of the stimulus.

## Load and Prepare Data

```{r}
firsttrial <- readRDS("firsttrial_data.rds")
time <- seq(0, 1, length.out = 256)

```

```{r}
library(fda)
library(dplyr)
library(caret)
library(randomForest)

# Load and prep data
firsttrial <- readRDS("firsttrial_data.rds")
time <- seq(0, 1, length.out = 256)

# Create bspline basis
basis <- fourier.basis(rangeval = range(time), nbasis = length(time)/2)
fdParObj <- fdPar(basis, Lfdobj = 2, lambda = 1e-2)

# FP1
fp1_data <- firsttrial %>% filter(sensor.position == "FP1") %>%
  arrange(matching.condition, subject.identifier, name, time)
mat_fp1 <- matrix(as.numeric(fp1_data$sensor.value), nrow = 256)
fd_fp1 <- smooth.basis(time, mat_fp1, fdParObj)$fd
res_fp1 <- pca.fd(fd_fp1, nharm = 6)
scores_fp1 <- as.data.frame(res_fp1$scores)
colnames(scores_fp1) <- paste0("FP1_", 1:6)

# FP2
fp2_data <- firsttrial %>% filter(sensor.position == "FP2") %>%
  arrange(matching.condition, subject.identifier, name, time)
mat_fp2 <- matrix(as.numeric(fp2_data$sensor.value), nrow = 256)
fd_fp2 <- smooth.basis(time, mat_fp2, fdParObj)$fd
res_fp2 <- pca.fd(fd_fp2, nharm = 6)
scores_fp2 <- as.data.frame(res_fp2$scores)
colnames(scores_fp2) <- paste0("FP2_", 1:6)

# Metadata
meta <- fp1_data %>% filter(time == 0) %>%
  select(matching.condition, subject.identifier)

# Combine
fpca_data <- cbind(meta, scores_fp1, scores_fp2)
fpca_data$matching.condition <- as.factor(fpca_data$matching.condition)

set.seed(123)
train_idx <- createDataPartition(fpca_data$matching.condition, p = 0.7, list = FALSE)
train_data <- fpca_data[train_idx, ]
test_data <- fpca_data[-train_idx, ]

# Check class balance
table(train_data$matching.condition)
table(test_data$matching.condition)


# Train model
rf_model <- randomForest(matching.condition ~ ., data = train_data, importance = TRUE)
pred <- predict(rf_model, newdata = test_data)

# Accuracy
acc <- mean(pred == test_data$matching.condition)
cat("Random Forest Accuracy (bspline, 7 harmonics):", round(acc * 100, 2), "%\n")

```

```{r}
library(rpart)
library(rpart.plot)

tree_model <- rpart(matching.condition ~ ., data = train_data, method = "class")
rpart.plot(tree_model, box.palette = "Blues", main = "Classification Tree")


# Predict and evaluate
tree_pred <- predict(tree_model, test_data, type = "class")
confusionMatrix(tree_pred, test_data$matching.condition)

```

