---
title: "Functional Data Analysis of EEG Data Comparing Alcoholics & Controls"
author: "Aoife O'Brien & Alannah Blacoe"
output: 
  revealjs::revealjs_presentation:
    theme: default
    transition: fade

---

```{r include=FALSE}

library(fda)
library(dplyr)
library(tidyr)
library(ggplot2)
library(scales)
library(patchwork)
library(gridExtra)


getwd()
install.packages("../fdapace_0.6.0.zip", repos = NULL, type = "win.binary")
library(fdapace)

```

```{r include=FALSE}
firsttrial <- readRDS("firsttrial_data.rds")         
fpca_scores_bspline <- readRDS("fpca_scores_bspline.rds")  
fpca_scores_fourier <- readRDS("fpca_scores_fourier.rds")  
final_clusters <- readRDS("final_clusters.rds")    
#bspline
res_fp1 <- readRDS("resfp1.rds")    
res_fp2 <- readRDS("resfp2.rds")  
#fourier
res.fp1 <- readRDS("res.fp1.rds")                  
res.fp2 <- readRDS("res.fp2.rds") 
```

---

## Objective

This study investigates the EEG (electroencephalogram) correlates of genetic predisposition to alcoholism by analysing brain activity in response to visual stimuli. Our aim was to apply Functional Data Analysis (FDA) methods to explore differences in EEG responses between alcoholic and control subjects, and to assess whether EEG signals can be used to predict predisposition to alcoholism.

---

## Background

Sensor data are increasingly common in health research and are typically long (many repeated measures over time). EEG signals, for instance, record hundreds of data points per second across multiple brain regions.

Functional Data Analysis (FDA) treats these signals as smooth functions rather than discrete points. FDA provides tools like Functional Principal Component Analysis (FPCA), functional t-tests, and regression that are well suited for this type of high-dimensional time-based data.

---

## Dataset

The dataset comes from a study examining genetic predisposition to alcoholism using EEG. It includes:

- **Subjects:** Two groups — alcoholic and control  
- **Electrodes:** 64 scalp electrodes  
- **Sampling rate:** 256 Hz
- **Trial duration:** 1 second per trial  
- **Stimuli:** Visual images from the 1980 Snodgrass and Vanderwart picture set

Focus is placed on two frontal electrodes (FP1 and FP2) for interpretability.

---

## Stimuli Conditions

Subjects were presented with one of three types of visual stimuli:

- **S1 Object:** A single image shown  
- **S2 Match:** Two images shown, with S1 identical to S2  
- **S2 Non-match:** Two images shown, with S1 different from S2  

Each trial captures 256 EEG measurements per electrode, for each stimulus condition.

---

## Research Questions

This study aims to address the following questions:

Question 1 : What is the mean difference in cognitive function between
Alcoholics & Controls?

Question 2 : What are the effects of the stimuli on EEG responses?

Question 3: Do alcoholics & controls participants show distinct EEG time-course
patterns?

Question 4 : Using the dataset, can we predict the second half of how each second
should look on the graphs using the first half/ can we make a predictive model?

---

## Methods Overview

  1. Data Preprocessing:
    Reshape trial data for FPCA.
    Focused on electrodes FP1 and FP2.

  2. FPCA:
    Fourier basis.
    B-Spline basis.
    PCA scores extracted from each curve.

  3.Clustering:
    K-means on FPCA scores (components 1–6).
    Explored grouping patterns by condition and subject group.

  4.Modelling:
    Lasso, Random Forests, and Trees to predict group using PCA scores.

---
  

## FPCA Visual Summary

- Scree plots: how much variance each principal component explains  
- Mean function: average EEG activity  
- Eigenfunctions: temporal patterns across PCs  

## FPCA – FP1 Curves

```{r include=FALSE}
dfresponse <- firsttrial %>%
  filter(sensor.position == "FP1") %>%
  dplyr::select(name, time, sensor.value) %>%
  na.omit() %>%
  group_by(name, time) %>%
  summarise(sensor.value = mean(sensor.value), .groups = "drop")

list_format <- split(dfresponse, dfresponse$name)
list_time <- lapply(list_format, function(df) df$time)
list_response <- lapply(list_format, function(df) df$sensor.value)

duplicates <- which(unlist(lapply(list_time, function(x) length(x) != length(unique(x)))))
if (length(duplicates) > 0) {
  list_time <- list_time[-duplicates]
  list_response <- list_response[-duplicates]
}

resPACE <- FPCA(Ly = list_response, Lt = list_time,
                optns = list(dataType = 'Sparse'))
```

```{r}
plot(resPACE)

```

---

## FPCA – FP2 Curves
```{r include=FALSE}
dfresponse <- firsttrial %>%
  filter(sensor.position == "FP2") %>%
  dplyr::select(name, time, sensor.value) %>%
  na.omit() %>%
  group_by(name, time) %>%
  summarise(sensor.value = mean(sensor.value), .groups = "drop")

list_format <- split(dfresponse, dfresponse$name)
list_time <- lapply(list_format, function(df) df$time)
list_response <- lapply(list_format, function(df) df$sensor.value)

duplicates <- which(unlist(lapply(list_time, function(x) length(x) != length(unique(x)))))
if (length(duplicates) > 0) {
  list_time <- list_time[-duplicates]
  list_response <- list_response[-duplicates]
}

resPACE2 <- FPCA(Ly = list_response, Lt = list_time,
                optns = list(dataType = 'Sparse'))

```

```{r}
plot(resPACE2)

```



---

## Clustered EEG Curve Plots

  Using PCA scores from FP1 and FP2, we applied k-means (k = 3):
    Visualised curves coloured by cluster membership
    Panel plot of one alcoholic, one control, one external subject per cluster
  
---

## K-means Clustering (FP1 + FP2 Scores)

```{r, echo=FALSE}
ggplot(final_clusters, aes(x = FP1_1, y = FP2_1, colour = cluster)) +
  geom_point(size = 3) +
  labs(title = "K-means Clustering on FP1 + FP2 Scores",
       subtitle = "Coloured by cluster label",
       x = "FP1 - PC1", y = "FP2 - PC1") +
  theme_minimal()
```


---



## Clusters by Matching Condition

```{r, echo=FALSE}
ggplot(final_clusters, aes(x = FP1_1, y = FP2_1, colour = matching.condition)) +
  geom_point(size = 3) +
  facet_wrap(~ cluster) +
  labs(title = "Clusters split by Matching Condition",
       x = "FP1 - PC1", y = "FP2 - PC1") +
  theme_minimal()
```

---



## Clusters by Alcoholism Status

```{r, echo=FALSE}
final_clusters$group <- ifelse(grepl("a", final_clusters$subject.identifier), "Alcoholic", "Control")

ggplot(final_clusters, aes(x = FP1_1, y = FP2_1, colour = group)) +
  geom_point(size = 3) +
  facet_wrap(~ cluster) +
  labs(title = "Clusters coloured by Alcoholism Status") +
  theme_minimal()
```


## Interpreting FP1 Scores

- Created `highfp1` and `lowfp1` groups (top/bottom 20%)  
- Plotted EEG curves coloured by score group  
- Boxplot: FP1 scores by alcoholism status  

---

### Wiggly Curves by FP1 and FP2 Score Grouping
```{r}
fpca_scores_fourier <- fpca_scores_fourier %>%
  mutate(fp1_group = case_when(
    FP1.1 >= quantile(FP1.1, 0.8) ~ "highfp1",
    FP1.1 <= quantile(FP1.1, 0.2) ~ "lowfp1",
    TRUE ~ NA_character_
  ),
  fp2_group = case_when(
    FP2.1 >= quantile(FP2.1, 0.8) ~ "highfp2",
    FP2.1 <= quantile(FP2.1, 0.2) ~ "lowfp2",
    TRUE ~ NA_character_
  )) %>%
  filter(!is.na(fp1_group) & !is.na(fp2_group))

set.seed(123)
high_names_fp2 <- fpca_scores_fourier %>% filter(fp2_group == "highfp2") %>% slice_sample(n = 8) %>% pull(name)
low_names_fp2 <- fpca_scores_fourier %>% filter(fp2_group == "lowfp2") %>% slice_sample(n = 8) %>% pull(name)
names_top_bottom_fp2 <- c(high_names_fp2, low_names_fp2)

wiggly_data_fp2 <- firsttrial %>%
  filter(name %in% names_top_bottom_fp2, sensor.position == "FP2") %>%
  left_join(fpca_scores_fourier %>% dplyr::select(name, fp2_group), by = "name")

ggplot(wiggly_data_fp2, aes(x = time, y = sensor.value, colour = fp2_group)) +
  geom_line(alpha = 0.8) +
  facet_wrap(~name) +
  labs(title = "EEG Curves by High vs Low FP2 Score",
       x = "Time", y = "Sensor Value") +
  theme_minimal()
```

---

### Smoothed FP1 and FP2 Curves by Metadata (Sampled Top/Bottom)
```{r include=FALSE}
sensor_list <- c("FP1", "FP2")
for (sensor in sensor_list) {
  eeg_data <- firsttrial %>% 
    filter(sensor.position == sensor, name %in% names_top_bottom_fp2) %>% 
    group_by(name) %>% 
    arrange(sample.num) %>% 
    ungroup()

  eeg_matrix <- matrix(as.numeric(eeg_data$sensor.value), nrow = 256)
  time <- seq(0, 1, length.out = 256)
  basis <- create.fourier.basis(c(0, 1), nbasis = 7)
  fdParObj <- fdPar(basis)
  fd_obj <- smooth.basis(time, eeg_matrix, fdParObj)$fd

  smoothed_matrix <- eval.fd(time, fd_obj)
  smoothed_df <- as.data.frame(smoothed_matrix)
  smoothed_df$time <- time
  smoothed_long <- pivot_longer(smoothed_df, cols = -time, names_to = "curve_id", values_to = "value")

  metadata <- eeg_data %>%
    dplyr::select(name, subject.identifier, matching.condition) %>%
    distinct() %>%
    mutate(curve_id = paste0("V", row_number()))

  smoothed_long <- smoothed_long %>%
    left_join(metadata, by = "curve_id")

  p1 <- ggplot(smoothed_long, aes(x = time, y = value, group = curve_id, colour = matching.condition)) +
    geom_line(size = 1, alpha = 0.9) +
    labs(title = paste("Smoothed", sensor, "EEG Curves by Matching Condition"),
         x = "Time", y = "Smoothed EEG Value") +
    theme_minimal()

  p2 <- ggplot(smoothed_long, aes(x = time, y = value, group = curve_id, colour = subject.identifier)) +
    geom_line(size = 1, alpha = 0.9) +
    labs(title = paste("Smoothed", sensor, "EEG Curves by Subject Identifier"),
         x = "Time", y = "Smoothed EEG Value") +
    theme_minimal() +
    theme(legend.position = "none")

  print(p1)
  print(p2)
}
```

```{r}
print(p1)
```

---

```{r}
print(p2)
```

---

## Predictive Modelling

  Trained models using FP1 and FP2 PCA scores:
    Lasso and Random Forest outperformed trees
    FP1+FP2 combined improved prediction modestly
    Accuracy highest when modelling group (alcoholic/control)  
  
---
*insert model comparison plot*

---

## Results

---

### Interpretation

RQ1: Differences in EEG patterns exist between groups

RQ2: PCA scores allow reasonable prediction of alcoholism status

RQ3: Matching condition impacts EEG; cluster structure partly reflects stimulus type

These results suggest functional features from EEG can capture meaningful group-level variation.



---